<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechStore | Tin công nghệ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="min-h-screen bg-gradient-to-b from-gray-50 to-white">
    <div id="site-header"></div>
    <script src="/include-partials.js" defer></script>

    <main class="max-w-6xl mx-auto px-4 py-8">
        <div id="detailCard" class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="p-10 text-center text-gray-500">Đang tải...</div>
        </div>
    </main>
    <div id="site-footer"></div>

    <script>
    (function() {
        const params = new URLSearchParams(window.location.search);
        const slug = params.get('slug');
        const card = document.getElementById('detailCard');

        if (!slug) {
            card.innerHTML = '<div class="text-center text-red-500">Không tìm thấy bài viết</div>';
            return;
        }

        const placeholder = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="800" height="450" viewBox="0 0 800 450"><rect width="800" height="450" fill="%23f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%239ca3af" font-size="32" font-family="Arial">No image</text></svg>';

        const apiUrl = `/api/news/${encodeURIComponent(slug)}`;

        fetch(apiUrl)
            .then(async (res) => {
                const text = await res.text();
                const contentType = res.headers.get('content-type') || '';
                if (!res.ok) {
                    throw new Error(text || 'Lỗi tải tin');
                }
                if (!contentType.includes('application/json')) {
                    throw new Error('Phản hồi không phải JSON (có thể backend hoặc gateway chưa khởi động)');
                }
                return JSON.parse(text);
            })
            .then(({ news }) => {
                const published = news.published_at ? new Date(news.published_at).toLocaleString('vi-VN') : '';
                const tags = Array.isArray(news.tags) ? news.tags : (typeof news.tags === 'string' ? (() => {
                    try { return JSON.parse(news.tags); } catch { return []; }
                })() : []);
                card.innerHTML = `
                    <div class="grid lg:grid-cols-[2fr_1fr] gap-10 p-8">
                        <div class="space-y-6">
                            <div class="inline-flex items-center gap-3 px-3 py-1.5 bg-red-50 text-red-700 rounded-full text-xs font-semibold uppercase">
                                ${news.category || 'Tech'}
                                <span class="w-1.5 h-1.5 bg-red-300 rounded-full"></span>
                                <span>${published || ''}</span>
                            </div>
                            <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 leading-tight">${news.title}</h1>
                            <div class="text-sm text-gray-500">Tác giả: ${news.author || 'TechStore News'}</div>
                            <div class="rounded-xl overflow-hidden bg-gray-100">
                                <img src="${news.thumbnail_url || placeholder}" alt="${news.title}" class="w-full h-auto object-cover" onerror="this.src='${placeholder}'">
                            </div>
                            <div class="prose max-w-none text-gray-800 leading-relaxed whitespace-pre-line">
                                ${news.content || ''}
                            </div>
                            ${tags.length ? `<div class="flex flex-wrap gap-2">
                                ${tags.map(t => `<span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">#${t}</span>`).join('')}
                            </div>` : ''}
                            ${news.source_url ? `<a href="${news.source_url}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 text-red-600 font-semibold">
                                Nguồn gốc bài viết
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h6m0 0v6m0-6L10 16"></path>
                                </svg>
                            </a>` : ''}
                        </div>
                        <div class="bg-gray-50 border border-gray-100 rounded-xl p-6 space-y-4">
                            <h3 class="text-lg font-semibold text-gray-800">Thông tin bài viết</h3>
                            <div class="text-sm text-gray-600 space-y-2">
                                <div><strong>Danh mục:</strong> ${news.category || 'Tech'}</div>
                                <div><strong>Ngày đăng:</strong> ${published || '—'}</div>
                                <div><strong>Tác giả:</strong> ${news.author || 'TechStore News'}</div>
                                ${news.source_url ? `<div class="break-all"><strong>Nguồn:</strong> <a class="text-red-600 hover:underline" target="_blank" rel="noopener" href="${news.source_url}">${news.source_url}</a></div>` : ''}
                            </div>
                            <a href="/?page=tech-news" class="inline-flex items-center gap-2 text-red-600 hover:text-red-700 font-semibold">
                                ← Xem danh sách tin
                            </a>
                        </div>
                    </div>
                `;
            })
            .catch((err) => {
                card.innerHTML = `
                    <div class="p-10 text-center">
                        <div class="text-red-500 font-semibold mb-2">Lỗi: ${err.message}</div>
                        <div class="text-sm text-gray-500">Kiểm tra: backend/gateway đã khởi động và route /api/news/:slug đang chạy.</div>
                        <a href="/?page=tech-news" class="mt-4 inline-flex items-center gap-2 text-red-600 hover:text-red-700 font-semibold">
                            ← Quay lại danh sách tin
                        </a>
                    </div>
                `;
            });
    })();
    </script>
</body>
</html>

