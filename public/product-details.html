<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ti·∫øt s·∫£n ph·∫©m - TechStore</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="/styles.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .product-image-main {
            transition: transform 0.3s ease;
        }
        .product-image-main:hover {
            transform: scale(1.05);
        }
        .product-thumbnail {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .product-thumbnail:hover {
            border-color: #dc2626;
            transform: scale(1.05);
        }
        .product-thumbnail.active {
            border-color: #dc2626;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-content {
            min-height: 200px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header Navigation -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <a href="/" class="text-2xl font-bold text-red-600">üõçÔ∏è TechStore</a>
                <nav class="flex items-center gap-4">
                    <a href="/" class="text-gray-700 hover:text-red-600">Trang ch·ªß</a>
                    <a href="/products.html" class="text-gray-700 hover:text-red-600">S·∫£n ph·∫©m</a>
                    <a href="/cart.html" class="text-gray-700 hover:text-red-600">Gi·ªè h√†ng</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-red-600"></div>
            <p class="mt-4 text-gray-600">ƒêang t·∫£i th√¥ng tin s·∫£n ph·∫©m...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-12">
            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</h2>
            <p class="text-gray-600 mb-4" id="errorMessage"></p>
            <a href="/products.html" class="inline-block bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors">
                Quay l·∫°i danh s√°ch s·∫£n ph·∫©m
            </a>
        </div>

        <!-- Product Details -->
        <div id="productDetails" class="hidden">
            <!-- Breadcrumb -->
            <nav class="mb-6">
                <ol class="flex items-center space-x-2 text-sm text-gray-600">
                    <li><a href="/" class="hover:text-red-600">Trang ch·ªß</a></li>
                    <li><span class="mx-2">/</span></li>
                    <li><a href="/products.html" class="hover:text-red-600">S·∫£n ph·∫©m</a></li>
                    <li><span class="mx-2">/</span></li>
                    <li id="breadcrumbCategory" class="text-gray-900"></li>
                    <li><span class="mx-2">/</span></li>
                    <li id="breadcrumbName" class="text-gray-900 font-semibold"></li>
                </ol>
            </nav>

            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 p-6">
                    <!-- Product Images -->
                    <div class="space-y-4">
                        <!-- Main Image -->
                        <div class="relative bg-gray-100 rounded-lg overflow-hidden aspect-square">
                            <img 
                                id="mainProductImage" 
                                src="" 
                                alt=""
                                class="product-image-main w-full h-full object-cover"
                            />
                            <div id="discountBadge" class="hidden absolute top-4 left-4 bg-red-600 text-white text-sm font-bold px-3 py-1 rounded z-10">
                                Gi·∫£m <span id="discountPercent"></span>%
                            </div>
                        </div>
                        
                        <!-- Thumbnail Images -->
                        <div id="thumbnailImages" class="grid grid-cols-4 gap-2">
                            <!-- Thumbnails will be inserted here -->
                        </div>
                    </div>

                    <!-- Product Info -->
                    <div class="space-y-6">
                        <!-- Category & Brand -->
                        <div>
                            <span id="productCategory" class="text-sm text-gray-500"></span>
                            <span id="productBrand" class="text-sm text-gray-500 ml-2"></span>
                        </div>

                        <!-- Product Name -->
                        <h1 id="productName" class="text-3xl font-bold text-gray-900"></h1>

                        <!-- Price -->
                        <div class="flex items-center gap-4">
                            <span id="productPrice" class="text-3xl font-bold text-red-600"></span>
                            <span id="productOriginalPrice" class="hidden text-xl text-gray-400 line-through"></span>
                        </div>

                        <!-- Product Tabs -->
                        <div class="mt-8 border-t pt-6">
                            <div class="flex border-b mb-4">
                                <button 
                                    onclick="switchTab('details')" 
                                    id="tabDetails"
                                    class="tab-button px-6 py-3 font-semibold text-gray-700 border-b-2 border-red-600 text-red-600"
                                >
                                    Details
                                </button>
                                <button 
                                    onclick="switchTab('info')" 
                                    id="tabInfo"
                                    class="tab-button px-6 py-3 font-semibold text-gray-500 hover:text-gray-700"
                                >
                                    Info
                                </button>
                                <button 
                                    onclick="switchTab('rating')" 
                                    id="tabRating"
                                    class="tab-button px-6 py-3 font-semibold text-gray-500 hover:text-gray-700"
                                >
                                    Rating
                                </button>
                            </div>

                            <!-- Tab Content: Details -->
                            <div id="tabContentDetails" class="tab-content">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Chi ti·∫øt s·∫£n ph·∫©m</h3>
                                
                                <!-- Product Overview -->
                                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <span class="text-sm font-medium text-gray-500">Th∆∞∆°ng hi·ªáu:</span>
                                            <span id="detailBrand" class="ml-2 text-gray-900 font-semibold"></span>
                                        </div>
                                        <div>
                                            <span class="text-sm font-medium text-gray-500">Danh m·ª•c:</span>
                                            <span id="detailCategory" class="ml-2 text-gray-900 font-semibold"></span>
                                        </div>
                                        <div>
                                            <span class="text-sm font-medium text-gray-500">Gi√° hi·ªán t·∫°i:</span>
                                            <span id="detailPrice" class="ml-2 text-red-600 font-bold text-lg"></span>
                                        </div>
                                        <div>
                                            <span class="text-sm font-medium text-gray-500">Gi√° g·ªëc:</span>
                                            <span id="detailOriginalPrice" class="ml-2 text-gray-400 line-through"></span>
                                        </div>
                                        <div>
                                            <span class="text-sm font-medium text-gray-500">T√¨nh tr·∫°ng:</span>
                                            <span id="detailStock" class="ml-2 text-gray-900 font-semibold"></span>
                                        </div>
                                        <div id="detailDiscount" class="hidden">
                                            <span class="text-sm font-medium text-gray-500">Gi·∫£m gi√°:</span>
                                            <span id="detailDiscountPercent" class="ml-2 text-red-600 font-bold"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Product Description -->
                                <div class="mb-6">
                                    <h4 class="text-md font-semibold text-gray-900 mb-3">M√¥ t·∫£ s·∫£n ph·∫©m</h4>
                                    <div id="productDescription" class="text-gray-700 leading-relaxed whitespace-pre-line"></div>
                                </div>

                                <!-- Product Highlights -->
                                <div id="productHighlights" class="mt-6">
                                    <!-- Highlights will be loaded here -->
                                </div>
                            </div>

                            <!-- Tab Content: Info (Technical Specifications) -->
                            <div id="tabContentInfo" class="tab-content hidden">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Th√¥ng tin k·ªπ thu·∫≠t</h3>
                                <div id="productSpecs" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Technical specs will be loaded here -->
                                </div>
                            </div>

                            <!-- Tab Content: Rating -->
                            <div id="tabContentRating" class="tab-content hidden">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">ƒê√°nh gi√° s·∫£n ph·∫©m</h3>
                                <div id="ratingSummary" class="mb-6">
                                    <!-- Rating summary will be loaded here -->
                                </div>
                            </div>
                        </div>

                        <!-- Stock Status -->
                        <div id="stockStatus" class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span class="text-sm text-gray-700">
                                C√≤n <span id="stockQuantity" class="font-semibold"></span> s·∫£n ph·∫©m
                            </span>
                        </div>

                        <!-- Add to Cart -->
                        <div class="space-y-4 pt-4 border-t">
                            <div class="flex items-center gap-4">
                                <label class="text-sm font-semibold text-gray-700">S·ªë l∆∞·ª£ng:</label>
                                <div class="flex items-center border rounded-lg">
                                    <button 
                                        id="decreaseQty" 
                                        class="px-4 py-2 hover:bg-gray-100 transition-colors"
                                        onclick="changeQuantity(-1)"
                                    >
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input 
                                        type="number" 
                                        id="productQuantity" 
                                        value="1" 
                                        min="1" 
                                        class="w-16 text-center border-0 focus:ring-0"
                                        onchange="validateQuantity()"
                                    />
                                    <button 
                                        id="increaseQty" 
                                        class="px-4 py-2 hover:bg-gray-100 transition-colors"
                                        onclick="changeQuantity(1)"
                                    >
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <button 
                                id="addToCartBtn"
                                onclick="handleAddToCart()"
                                class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg transition-colors text-lg"
                            >
                                <i class="fas fa-shopping-cart mr-2"></i>
                                Th√™m v√†o gi·ªè h√†ng
                            </button>
                            
                            <button 
                                id="loginToBuyBtn"
                                onclick="window.location.href='/login.html'"
                                class="hidden w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 px-6 rounded-lg transition-colors text-lg"
                            >
                                <i class="fas fa-sign-in-alt mr-2"></i>
                                ƒêƒÉng nh·∫≠p ƒë·ªÉ mua
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Related Products Section (Shopee Style) -->
            <div class="mt-12">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">C√ì TH·ªÇ B·∫†N C≈®NG TH√çCH</h2>
                </div>
                <div id="relatedProducts" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    <!-- Related products will be loaded here -->
                </div>
            </div>

            <!-- Rating & Reviews Section (Shopee Style) -->
            <div class="mt-12 bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ƒê√ÅNH GI√Å S·∫¢N PH·∫®M</h2>
                
                <!-- Rating Summary -->
                <div id="ratingSummaryHeader" class="mb-6 pb-6 border-b">
                    <div class="flex flex-col md:flex-row gap-6">
                        <!-- Overall Rating (Left) -->
                        <div class="flex-shrink-0">
                            <div class="text-5xl font-bold text-orange-500 mb-2" id="averageRating">0</div>
                            <div class="text-orange-500 text-2xl mb-2" id="ratingStars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                            <div class="text-sm text-gray-500" id="totalReviews">0 ƒë√°nh gi√°</div>
                        </div>
                        
                        <!-- Rating Filters (Right) -->
                        <div class="flex-1">
                            <div id="ratingFilters" class="space-y-2">
                                <!-- Rating filters will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comment Form (only if logged in) -->
                <div id="commentFormContainer" class="hidden mb-8 border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n</h3>
                    <form id="commentForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°nh gi√° (sao)</label>
                            <div class="flex items-center gap-2">
                                <select id="commentRating" class="border rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                    <option value="5">5 sao - Tuy·ªát v·ªùi</option>
                                    <option value="4">4 sao - T·ªët</option>
                                    <option value="3">3 sao - B√¨nh th∆∞·ªùng</option>
                                    <option value="2">2 sao - Kh√¥ng t·ªët</option>
                                    <option value="1">1 sao - R·∫•t t·ªá</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">B√¨nh lu·∫≠n</label>
                            <textarea 
                                id="commentText" 
                                rows="4" 
                                class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ s·∫£n ph·∫©m n√†y..."
                                required
                            ></textarea>
                        </div>
                        <button 
                            type="submit" 
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors"
                        >
                            <i class="fas fa-paper-plane mr-2"></i>
                            G·ª≠i ƒë√°nh gi√°
                        </button>
                    </form>
                </div>

                <!-- Login prompt (if not logged in) -->
                <div id="loginPrompt" class="mb-8 border-b pb-6">
                    <p class="text-gray-600 mb-4">Vui l√≤ng <a href="/login.html" class="text-red-600 hover:underline font-semibold">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ vi·∫øt ƒë√°nh gi√°.</p>
                </div>

                <!-- Comments List -->
                <div id="commentsList" class="space-y-6">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>ƒêang t·∫£i b√¨nh lu·∫≠n...</p>
                    </div>
                </div>

                <!-- Pagination -->
                <div id="commentsPagination" class="mt-6 flex justify-center items-center gap-2">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 bg-green-500 text-white rounded-lg shadow-lg p-4 z-50"></div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let currentProduct = null;
        let currentQuantity = 1;
        let currentUser = null;

        // L·∫•y token v√† user info
        function getToken() {
            return localStorage.getItem('token');
        }

        function getCachedUser() {
            try {
                const raw = localStorage.getItem('user_info');
                return raw ? JSON.parse(raw) : null;
            } catch {
                return null;
            }
        }

        // Format gi√°
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN').format(price) + ' ‚Ç´';
        }

        // Show toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            toast.className = `fixed bottom-4 right-4 ${bgColor} text-white rounded-lg shadow-lg p-4 z-50`;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Load product detail
        async function loadProductDetail() {
            const urlParams = new URLSearchParams(window.location.search);
            const slug = urlParams.get('slug');
            
            if (!slug) {
                showError('Kh√¥ng t√¨m th·∫•y th√¥ng tin s·∫£n ph·∫©m');
                return;
            }

            try {
                // T√¨m s·∫£n ph·∫©m theo slug s·ª≠ d·ª•ng endpoint chuy√™n d·ª•ng
                const response = await fetch(`${API_BASE_URL}/products/by-slug/${encodeURIComponent(slug)}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showError('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const product = await response.json();
                
                if (!product || !product.id) {
                    showError('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m');
                    return;
                }

                currentProduct = product;
                renderProductDetail(product);
                
            } catch (error) {
                console.error('Error loading product:', error);
                showError('L·ªói khi t·∫£i th√¥ng tin s·∫£n ph·∫©m: ' + error.message);
            }
        }

        // Helper function ƒë·ªÉ t·∫°o slug t·ª´ t√™n s·∫£n ph·∫©m
        function createSlug(name) {
            return name
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
        }

        function renderProductDetail(product) {
            // Hide loading, show product details
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('productDetails').classList.remove('hidden');

            // Parse images t·ª´ database
            let dbImages = [];
            if (product.images) {
                try {
                    dbImages = typeof product.images === 'string' ? JSON.parse(product.images) : product.images;
                } catch (e) {
                    dbImages = [];
                }
            }
            
            // Load ·∫£nh t·ª´ folder structure: /img/products/[slug]/1.jpg, 2.jpg, 3.jpg, 4.jpg
            const slug = product.slug || createSlug(product.name);
            const basePath = `/img/products/${slug}`;
            
            console.log('Product slug:', slug);
            console.log('Base path:', basePath);
            
            // Fallback v·ªÅ database n·∫øu folder kh√¥ng c√≥ ·∫£nh
            const fallbackMainImage = product.main_image_url || product.image_url || product.image || '/img/placeholder.png';
            const fallbackImages = [fallbackMainImage, ...dbImages].slice(0, 4);
            
            // Main image lu√¥n l√† 1.jpg t·ª´ folder
            const mainImage = `${basePath}/1.jpg`;
            document.getElementById('mainProductImage').src = mainImage;
            document.getElementById('mainProductImage').alt = product.name;
            document.getElementById('mainProductImage').onerror = function() {
                // N·∫øu ·∫£nh t·ª´ folder kh√¥ng load ƒë∆∞·ª£c, d√πng ·∫£nh t·ª´ database
                this.src = fallbackMainImage;
                this.onerror = null;
            };

            // Thumbnail images - load t·ª´ database images field (ƒë√£ ƒë∆∞·ª£c format ƒë√∫ng)
            const thumbnailContainer = document.getElementById('thumbnailImages');
            
            // Parse images t·ª´ database (ƒë√£ ƒë∆∞·ª£c format th√†nh array ch·ª©a /img/products/[slug]/2.jpg, 3.jpg, 4.jpg)
            let thumbnailImages = [];
            
            // Th√™m main image (1.jpg) v√†o ƒë·∫ßu
            const mainImagePath = `${basePath}/1.jpg`;
            thumbnailImages.push(mainImagePath);
            
            console.log('Base path:', basePath);
            console.log('Product images (raw):', product.images);
            console.log('Product images type:', typeof product.images);
            
            // Th√™m c√°c ·∫£nh t·ª´ database images field (ƒë√£ ƒë∆∞·ª£c format ƒë√∫ng)
            if (product.images) {
                try {
                    let dbImagesArray;
                    if (typeof product.images === 'string') {
                        dbImagesArray = JSON.parse(product.images);
                    } else if (Array.isArray(product.images)) {
                        dbImagesArray = product.images;
                    } else {
                        dbImagesArray = [];
                    }
                    
                    console.log('Parsed images array:', dbImagesArray);
                    
                    if (Array.isArray(dbImagesArray) && dbImagesArray.length > 0) {
                        thumbnailImages = thumbnailImages.concat(dbImagesArray);
                        console.log('Added images from database:', dbImagesArray.length);
                    }
                } catch (e) {
                    console.error('Error parsing images:', e);
                }
            }
            
            // N·∫øu kh√¥ng c√≥ ·∫£nh t·ª´ database, th·ª≠ load t·ª´ folder structure
            if (thumbnailImages.length === 1) {
                console.log('No images from database, trying folder structure');
                // Ch·ªâ c√≥ main image, th·ª≠ th√™m 2.jpg, 3.jpg, 4.jpg
                for (let i = 2; i <= 4; i++) {
                    thumbnailImages.push(`${basePath}/${i}.jpg`);
                }
            }
            
            console.log('Final thumbnail images to render:', thumbnailImages);
            console.log('Total thumbnails:', thumbnailImages.length);
            
            // Render thumbnails - ·∫©n n·∫øu ·∫£nh kh√¥ng load ƒë∆∞·ª£c
            thumbnailContainer.innerHTML = thumbnailImages.map((img, idx) => `
                <div 
                    class="product-thumbnail ${idx === 0 ? 'active' : ''} bg-gray-100 rounded-lg overflow-hidden aspect-square cursor-pointer"
                    onclick="changeMainImage('${img}', ${idx})"
                    data-thumb-index="${idx}"
                >
                    <img 
                        src="${img}" 
                        alt="Thumbnail ${idx + 1}" 
                        class="w-full h-full object-cover"
                        onerror="console.log('Image failed to load:', '${img}'); this.parentElement.style.display='none';"
                        onload="console.log('Image loaded:', '${img}'); this.parentElement.style.display='block';"
                    />
                </div>
            `).join('');

            // Product info
            document.getElementById('breadcrumbCategory').textContent = product.category || 'S·∫£n ph·∫©m';
            document.getElementById('breadcrumbName').textContent = product.name;
            document.getElementById('productCategory').textContent = product.category || '';
            if (product.brand) {
                document.getElementById('productBrand').textContent = `‚Ä¢ ${product.brand}`;
            }
            document.getElementById('productName').textContent = product.name;
            document.getElementById('productPrice').textContent = formatPrice(product.price);
            document.getElementById('productDescription').textContent = product.description || 'Ch∆∞a c√≥ m√¥ t·∫£';

            // Original price & discount
            if (product.original_price && product.original_price > product.price) {
                const discount = Math.round(((product.original_price - product.price) / product.original_price) * 100);
                document.getElementById('productOriginalPrice').textContent = formatPrice(product.original_price);
                document.getElementById('productOriginalPrice').classList.remove('hidden');
                document.getElementById('discountBadge').classList.remove('hidden');
                document.getElementById('discountPercent').textContent = discount;
            }

            // Stock
            const stock = product.stock_quantity || product.stock || 0;
            document.getElementById('stockQuantity').textContent = stock;
            if (stock === 0) {
                document.getElementById('stockStatus').innerHTML = `
                    <i class="fas fa-times-circle text-red-500"></i>
                    <span class="text-sm text-red-600 font-semibold">H·∫øt h√†ng</span>
                `;
                document.getElementById('addToCartBtn').disabled = true;
                document.getElementById('addToCartBtn').classList.add('opacity-50', 'cursor-not-allowed');
            }

            // Check user login
            currentUser = getCachedUser();
            if (currentUser) {
                document.getElementById('addToCartBtn').classList.remove('hidden');
                document.getElementById('loginToBuyBtn').classList.add('hidden');
                document.getElementById('commentFormContainer').classList.remove('hidden');
                document.getElementById('loginPrompt').classList.add('hidden');
            } else {
                document.getElementById('addToCartBtn').classList.add('hidden');
                document.getElementById('loginToBuyBtn').classList.remove('hidden');
                document.getElementById('commentFormContainer').classList.add('hidden');
                document.getElementById('loginPrompt').classList.remove('hidden');
            }

            // Load product details, specs and related products
            loadProductDetails(product);
            loadProductSpecs(product);
            loadRelatedProducts(product);
            loadComments(product.id);
        }

        function changeMainImage(imageUrl, index, fallbackUrl = null) {
            const mainImg = document.getElementById('mainProductImage');
            mainImg.src = imageUrl;
            
            // N·∫øu ·∫£nh kh√¥ng load ƒë∆∞·ª£c, d√πng fallback
            if (fallbackUrl) {
                mainImg.onerror = function() {
                    this.src = fallbackUrl;
                    this.onerror = null;
                };
            }
            
            // Update active thumbnail
            document.querySelectorAll('.product-thumbnail').forEach((thumb, i) => {
                if (i === index) {
                    thumb.classList.add('active');
                } else {
                    thumb.classList.remove('active');
                }
            });
        }

        function changeQuantity(delta) {
            const maxStock = currentProduct?.stock_quantity || currentProduct?.stock || 999;
            currentQuantity = Math.max(1, Math.min(maxStock, currentQuantity + delta));
            document.getElementById('productQuantity').value = currentQuantity;
        }

        function validateQuantity() {
            const input = document.getElementById('productQuantity');
            const maxStock = currentProduct?.stock_quantity || currentProduct?.stock || 999;
            currentQuantity = Math.max(1, Math.min(maxStock, parseInt(input.value) || 1));
            input.value = currentQuantity;
        }

        async function handleAddToCart() {
            if (!currentUser) {
                window.location.href = '/login.html';
                return;
            }

            if (!currentProduct) {
                showToast('L·ªói: Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m', 'error');
                return;
            }

            try {
                const token = getToken();
                if (!token) {
                    showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng', 'error');
                    window.location.href = '/login.html';
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/cart/items`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        product_id: currentProduct.id,
                        quantity: currentQuantity
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'L·ªói khi th√™m v√†o gi·ªè h√†ng');
                }

                showToast(`ƒê√£ th√™m ${currentQuantity} s·∫£n ph·∫©m v√†o gi·ªè h√†ng!`, 'success');
                
            } catch (error) {
                console.error('Error adding to cart:', error);
                showToast(error.message || 'L·ªói khi th√™m v√†o gi·ªè h√†ng', 'error');
            }
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // Helper function ƒë·ªÉ l·∫•y ·∫£nh s·∫£n ph·∫©m (d√πng cho related products)
        function getProductImageForRelated(p) {
            const slug = p.slug || createSlug(p.name);
            const basePath = `/img/products/${slug}`;
            return `${basePath}/1.jpg`;
        }

        // Load related products (same category, exclude current product)
        async function loadRelatedProducts(product) {
            try {
                const response = await fetch(`${API_BASE_URL}/products?category=${encodeURIComponent(product.category)}&limit=4`);
                const data = await response.json();
                
                // Filter out current product
                const relatedProducts = (data.products || []).filter(p => p.id !== product.id).slice(0, 4);
                
                const container = document.getElementById('relatedProducts');
                if (relatedProducts.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">Ch∆∞a c√≥ s·∫£n ph·∫©m li√™n quan</p>';
                    return;
                }

                container.innerHTML = relatedProducts.map(p => {
                    const discount = p.original_price && p.original_price > p.price 
                        ? Math.round(((p.original_price - p.price) / p.original_price) * 100) 
                        : 0;
                    
                    return `
                        <div class="bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-lg transition-all cursor-pointer border border-gray-100" onclick="window.location.href='/product-details.html?slug=${p.slug || p.id}'">
                            <div class="relative aspect-square bg-gray-100 overflow-hidden">
                                <img 
                                    src="${getProductImageForRelated(p)}" 
                                    alt="${p.name}"
                                    class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                                    onerror="this.src='${p.main_image_url || p.image_url || p.image || '/img/placeholder.png'}'; this.onerror=null;"
                                />
                                ${discount > 0 ? `
                                    <div class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded">
                                        -${discount}%
                                    </div>
                                ` : ''}
                            </div>
                            <div class="p-3">
                                <h3 class="font-medium text-gray-900 mb-2 line-clamp-2 text-sm h-10">${p.name}</h3>
                                <div class="flex items-center gap-1 mb-2">
                                    <span class="text-yellow-500 text-xs">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                                    <span class="text-gray-500 text-xs">(0)</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <p class="text-red-600 font-bold text-base">${formatPrice(p.price)}</p>
                                    ${p.original_price && p.original_price > p.price ? `
                                        <p class="text-gray-400 text-xs line-through">${formatPrice(p.original_price)}</p>
                                    ` : ''}
                                </div>
                                <p class="text-gray-500 text-xs mt-1">ƒê√£ b√°n 0</p>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading related products:', error);
                document.getElementById('relatedProducts').innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m li√™n quan</p>';
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-b-2', 'border-red-600', 'text-red-600');
                btn.classList.add('text-gray-500');
            });
            
            // Show selected tab content
            const contentId = `tabContent${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`;
            const buttonId = `tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`;
            
            document.getElementById(contentId).classList.remove('hidden');
            const button = document.getElementById(buttonId);
            button.classList.remove('text-gray-500');
            button.classList.add('border-b-2', 'border-red-600', 'text-red-600');
            
            // Load rating data if switching to rating tab
            if (tabName === 'rating' && currentProduct) {
                loadRatingSummary(currentProduct.id);
            }
        }

        // Load product details (chi ti·∫øt h∆°n)
        function loadProductDetails(product) {
            // Brand
            document.getElementById('detailBrand').textContent = product.brand || 'Ch∆∞a c√≥ th√¥ng tin';
            
            // Category
            document.getElementById('detailCategory').textContent = product.category || 'Ch∆∞a ph√¢n lo·∫°i';
            
            // Price
            document.getElementById('detailPrice').textContent = formatPrice(product.price);
            
            // Original price
            if (product.original_price && product.original_price > product.price) {
                document.getElementById('detailOriginalPrice').textContent = formatPrice(product.original_price);
                document.getElementById('detailOriginalPrice').classList.remove('hidden');
                const discount = Math.round(((product.original_price - product.price) / product.original_price) * 100);
                document.getElementById('detailDiscountPercent').textContent = `${discount}%`;
                document.getElementById('detailDiscount').classList.remove('hidden');
            } else {
                document.getElementById('detailOriginalPrice').classList.add('hidden');
                document.getElementById('detailDiscount').classList.add('hidden');
            }
            
            // Stock
            const stock = product.stock_quantity || product.stock || 0;
            const stockElement = document.getElementById('detailStock');
            if (stock > 0) {
                stockElement.textContent = `C√≤n ${stock} s·∫£n ph·∫©m`;
                stockElement.classList.remove('text-red-600');
                stockElement.classList.add('text-green-600');
            } else {
                stockElement.textContent = 'H·∫øt h√†ng';
                stockElement.classList.remove('text-green-600');
                stockElement.classList.add('text-red-600');
            }
            
            // Description
            const descElement = document.getElementById('productDescription');
            if (product.description && product.description.trim()) {
                descElement.textContent = product.description;
            } else {
                descElement.innerHTML = '<p class="text-gray-400 italic">Ch∆∞a c√≥ m√¥ t·∫£ chi ti·∫øt v·ªÅ s·∫£n ph·∫©m n√†y.</p>';
            }
            
            // Product Highlights (t·ª± ƒë·ªông t·∫°o t·ª´ th√¥ng tin k·ªπ thu·∫≠t)
            const highlights = [];
            if (product.processor_name) highlights.push(`Chip ${product.processor_name}`);
            if (product.ram_gb) highlights.push(`RAM ${product.ram_gb}GB`);
            if (product.ssd_gb) highlights.push(`SSD ${product.ssd_gb}GB`);
            if (product.screen_size_inches) highlights.push(`M√†n h√¨nh ${product.screen_size_inches}"`);
            if (product.graphics) highlights.push(`Card ƒë·ªì h·ªça ${product.graphics}`);
            
            const highlightsContainer = document.getElementById('productHighlights');
            if (highlights.length > 0) {
                highlightsContainer.innerHTML = `
                    <h4 class="text-md font-semibold text-gray-900 mb-3">ƒêi·ªÉm n·ªïi b·∫≠t</h4>
                    <div class="flex flex-wrap gap-2">
                        ${highlights.map(h => `
                            <span class="px-3 py-1 bg-red-50 text-red-700 rounded-full text-sm font-medium">
                                ${h}
                            </span>
                        `).join('')}
                    </div>
                `;
            } else {
                highlightsContainer.innerHTML = '';
            }
        }

        // Load product technical specifications (t·ª´ database)
        function loadProductSpecs(product) {
            const specs = [];
            
            // Th√¥ng tin c∆° b·∫£n
            if (product.brand) specs.push({ label: 'Th∆∞∆°ng hi·ªáu', value: product.brand, category: 'basic' });
            if (product.category) specs.push({ label: 'Danh m·ª•c', value: product.category, category: 'basic' });
            
            // Th√¥ng tin k·ªπ thu·∫≠t - CPU
            if (product.processor_name) specs.push({ label: 'CPU / B·ªô x·ª≠ l√Ω', value: product.processor_name, category: 'cpu' });
            if (product.no_of_cores) specs.push({ label: 'S·ªë nh√¢n CPU', value: `${product.no_of_cores} nh√¢n`, category: 'cpu' });
            if (product.no_of_threads) specs.push({ label: 'S·ªë lu·ªìng CPU', value: `${product.no_of_threads} lu·ªìng`, category: 'cpu' });
            
            // Th√¥ng tin k·ªπ thu·∫≠t - B·ªô nh·ªõ
            if (product.ram_gb) {
                const ram = typeof product.ram_gb === 'string' ? parseInt(product.ram_gb) : product.ram_gb;
                specs.push({ label: 'RAM', value: `${ram} GB`, category: 'memory' });
            }
            if (product.ssd_gb) {
                const ssd = typeof product.ssd_gb === 'string' ? parseInt(product.ssd_gb) : product.ssd_gb;
                specs.push({ label: 'SSD', value: `${ssd} GB`, category: 'memory' });
            }
            if (product.hard_disk_gb && product.hard_disk_gb > 0) {
                const hdd = typeof product.hard_disk_gb === 'string' ? parseInt(product.hard_disk_gb) : product.hard_disk_gb;
                specs.push({ label: 'HDD', value: `${hdd} GB`, category: 'memory' });
            }
            
            // Th√¥ng tin k·ªπ thu·∫≠t - M√†n h√¨nh
            if (product.screen_size_inches) {
                const screenSize = typeof product.screen_size_inches === 'string' 
                    ? parseFloat(product.screen_size_inches) 
                    : product.screen_size_inches;
                specs.push({ label: 'K√≠ch th∆∞·ªõc m√†n h√¨nh', value: `${screenSize}"`, category: 'display' });
            }
            if (product.resolution) specs.push({ label: 'ƒê·ªô ph√¢n gi·∫£i', value: product.resolution, category: 'display' });
            
            // Th√¥ng tin k·ªπ thu·∫≠t - ƒê·ªì h·ªça & H·ªá ƒëi·ªÅu h√†nh
            if (product.graphics) specs.push({ label: 'Card ƒë·ªì h·ªça', value: product.graphics, category: 'graphics' });
            if (product.operating_system) specs.push({ label: 'H·ªá ƒëi·ªÅu h√†nh', value: product.operating_system, category: 'os' });
            
            // Th√¥ng tin k·ªπ thu·∫≠t - ƒê√°nh gi√°
            if (product.spec_score) specs.push({ label: 'ƒêi·ªÉm ƒë√°nh gi√°', value: `${product.spec_score}/100`, category: 'rating' });
            
            // Th√¥ng tin b√°n h√†ng
            if (product.stock_quantity !== undefined) {
                const stock = product.stock_quantity || 0;
                specs.push({ label: 'T·ªìn kho', value: stock > 0 ? `${stock} s·∫£n ph·∫©m` : 'H·∫øt h√†ng', category: 'stock' });
            }
            
            const specsContainer = document.getElementById('productSpecs');
            if (specs.length === 0) {
                specsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">Ch∆∞a c√≥ th√¥ng tin k·ªπ thu·∫≠t</p>';
            } else {
                // Nh√≥m theo category
                const groupedSpecs = {
                    basic: specs.filter(s => s.category === 'basic'),
                    cpu: specs.filter(s => s.category === 'cpu'),
                    memory: specs.filter(s => s.category === 'memory'),
                    display: specs.filter(s => s.category === 'display'),
                    graphics: specs.filter(s => s.category === 'graphics'),
                    os: specs.filter(s => s.category === 'os'),
                    rating: specs.filter(s => s.category === 'rating'),
                    stock: specs.filter(s => s.category === 'stock')
                };
                
                const categoryLabels = {
                    basic: 'Th√¥ng tin c∆° b·∫£n',
                    cpu: 'B·ªô x·ª≠ l√Ω',
                    memory: 'B·ªô nh·ªõ',
                    display: 'M√†n h√¨nh',
                    graphics: 'ƒê·ªì h·ªça',
                    os: 'H·ªá ƒëi·ªÅu h√†nh',
                    rating: 'ƒê√°nh gi√°',
                    stock: 'T·ªìn kho'
                };
                
                let html = '';
                Object.keys(groupedSpecs).forEach(category => {
                    if (groupedSpecs[category].length > 0) {
                        html += `
                            <div class="col-span-full mb-4">
                                <h4 class="font-semibold text-gray-800 mb-2 pb-2 border-b">${categoryLabels[category]}</h4>
                                <div class="space-y-2">
                                    ${groupedSpecs[category].map(spec => `
                                        <div class="flex justify-between py-2 border-b border-gray-100">
                                            <span class="font-medium text-gray-700">${spec.label}:</span>
                                            <span class="text-gray-900 text-right">${spec.value}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                });
                
                specsContainer.innerHTML = html;
            }
        }

        let currentRatingFilter = 'all';
        let currentCommentsPage = 1;
        const commentsPerPage = 5;

        // Load rating summary and filters
        async function loadRatingSummary(productId) {
            try {
                const response = await fetch(`${API_BASE_URL}/comments/product/${productId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load ratings');
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error('Server returned non-JSON response');
                }
                
                const data = await response.json();
                const comments = data.comments || [];
                
                if (comments.length === 0) {
                    document.getElementById('ratingSummaryHeader').innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-star text-4xl mb-4 text-gray-300"></i>
                            <p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</p>
                        </div>
                    `;
                    return;
                }
                
                // Calculate rating distribution
                const ratingCounts = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
                let totalRating = 0;
                let commentsWithText = 0;
                
                comments.forEach(comment => {
                    const rating = comment.rating || 5;
                    if (ratingCounts[rating] !== undefined) {
                        ratingCounts[rating]++;
                    }
                    totalRating += rating;
                    if (comment.comment && comment.comment.trim().length > 0) {
                        commentsWithText++;
                    }
                });
                
                const averageRating = (totalRating / comments.length).toFixed(1);
                const totalComments = comments.length;
                
                // Format s·ªë l∆∞·ª£ng (3,8k format)
                function formatCount(count) {
                    if (count >= 1000) {
                        return (count / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
                    }
                    return count.toString();
                }
                
                // Update rating display (Shopee style - m√†u cam)
                document.getElementById('averageRating').textContent = `${averageRating} tr√™n 5`;
                const fullStars = Math.round(averageRating);
                document.getElementById('ratingStars').innerHTML = 
                    '<span class="text-orange-500">‚òÖ</span>'.repeat(fullStars) + 
                    '<span class="text-gray-300">‚òÖ</span>'.repeat(5 - fullStars);
                document.getElementById('totalReviews').textContent = `${totalComments} ƒë√°nh gi√°`;
                
                // Render rating filters (Shopee style - 2 h√†ng)
                const filtersHtml = `
                    <div class="flex flex-wrap gap-2 mb-2">
                        <button 
                            onclick="filterComments('all', ${productId})" 
                            class="filter-btn px-4 py-2 rounded border transition-all ${currentRatingFilter === 'all' ? 'bg-orange-50 text-orange-600 border-orange-500 font-semibold' : 'bg-white text-gray-700 border-gray-300 hover:border-orange-500 hover:text-orange-600'}"
                        >
                            T·∫•t C·∫£ (${formatCount(totalComments)})
                        </button>
                        <button 
                            onclick="filterComments(5, ${productId})" 
                            class="filter-btn px-4 py-2 rounded border transition-all ${currentRatingFilter === 5 ? 'bg-orange-50 text-orange-600 border-orange-500 font-semibold' : 'bg-white text-gray-700 border-gray-300 hover:border-orange-500 hover:text-orange-600'}"
                        >
                            5 Sao (${formatCount(ratingCounts[5])})
                        </button>
                        <button 
                            onclick="filterComments(4, ${productId})" 
                            class="filter-btn px-4 py-2 rounded border transition-all ${currentRatingFilter === 4 ? 'bg-orange-50 text-orange-600 border-orange-500 font-semibold' : 'bg-white text-gray-700 border-gray-300 hover:border-orange-500 hover:text-orange-600'}"
                        >
                            4 Sao (${formatCount(ratingCounts[4])})
                        </button>
                        <button 
                            onclick="filterComments(3, ${productId})" 
                            class="filter-btn px-4 py-2 rounded border transition-all ${currentRatingFilter === 3 ? 'bg-orange-50 text-orange-600 border-orange-500 font-semibold' : 'bg-white text-gray-700 border-gray-300 hover:border-orange-500 hover:text-orange-600'}"
                        >
                            3 Sao (${formatCount(ratingCounts[3])})
                        </button>
                        <button 
                            onclick="filterComments(2, ${productId})" 
                            class="filter-btn px-4 py-2 rounded border transition-all ${currentRatingFilter === 2 ? 'bg-orange-50 text-orange-600 border-orange-500 font-semibold' : 'bg-white text-gray-700 border-gray-300 hover:border-orange-500 hover:text-orange-600'}"
                        >
                            2 Sao (${formatCount(ratingCounts[2])})
                        </button>
                        <button 
                            onclick="filterComments(1, ${productId})" 
                            class="filter-btn px-4 py-2 rounded border transition-all ${currentRatingFilter === 1 ? 'bg-orange-50 text-orange-600 border-orange-500 font-semibold' : 'bg-white text-gray-700 border-gray-300 hover:border-orange-500 hover:text-orange-600'}"
                        >
                            1 Sao (${formatCount(ratingCounts[1])})
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button 
                            onclick="filterComments('withComment', ${productId})" 
                            class="filter-btn px-4 py-2 rounded border transition-all ${currentRatingFilter === 'withComment' ? 'bg-orange-50 text-orange-600 border-orange-500 font-semibold' : 'bg-white text-gray-700 border-gray-300 hover:border-orange-500 hover:text-orange-600'}"
                        >
                            C√≥ B√¨nh Lu·∫≠n (${formatCount(commentsWithText)})
                        </button>
                        <button 
                            onclick="filterComments('withMedia', ${productId})" 
                            class="filter-btn px-4 py-2 rounded border transition-all ${currentRatingFilter === 'withMedia' ? 'bg-orange-50 text-orange-600 border-orange-500 font-semibold' : 'bg-white text-gray-700 border-gray-300 hover:border-orange-500 hover:text-orange-600'}"
                            disabled
                            title="T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn"
                        >
                            C√≥ H√¨nh ·∫¢nh / Video (0)
                        </button>
                    </div>
                `;
                
                document.getElementById('ratingFilters').innerHTML = filtersHtml;
                
            } catch (error) {
                console.error('Error loading rating summary:', error);
            }
        }

        // Filter comments by rating
        function filterComments(rating, productId) {
            currentRatingFilter = rating;
            currentCommentsPage = 1;
            loadComments(productId);
        }

        // Load comments for product (Shopee style)
        async function loadComments(productId) {
            try {
                // GET comments l√† public, kh√¥ng c·∫ßn Authorization header
                const response = await fetch(`${API_BASE_URL}/comments/product/${productId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error loading comments:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error('Server returned non-JSON response');
                }
                
                const data = await response.json();
                let comments = data.comments || [];
                
                // Filter comments by rating if filter is active
                if (currentRatingFilter !== 'all') {
                    if (currentRatingFilter === 'withComment') {
                        comments = comments.filter(c => c.comment && c.comment.trim().length > 0);
                    } else if (currentRatingFilter === 'withMedia') {
                        // Filter comments with media (placeholder for future feature)
                        comments = comments.filter(c => false); // Ch∆∞a c√≥ media
                    } else {
                        comments = comments.filter(c => (c.rating || 5) === currentRatingFilter);
                    }
                }
                
                const commentsList = document.getElementById('commentsList');
                
                if (comments.length === 0) {
                    commentsList.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-comments text-4xl mb-4 text-gray-300"></i>
                            <p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n ƒë√°nh gi√° s·∫£n ph·∫©m n√†y!</p>
                        </div>
                    `;
                    document.getElementById('commentsPagination').innerHTML = '';
                    return;
                }

                // Pagination
                const totalPages = Math.ceil(comments.length / commentsPerPage);
                const startIndex = (currentCommentsPage - 1) * commentsPerPage;
                const endIndex = startIndex + commentsPerPage;
                const paginatedComments = comments.slice(startIndex, endIndex);

                // Render comments (Shopee style)
                commentsList.innerHTML = paginatedComments.map(comment => {
                    const date = new Date(comment.created_at);
                    const formattedDate = date.toLocaleDateString('vi-VN', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const rating = comment.rating || 5;
                    const stars = '<span class="text-red-600">‚òÖ</span>'.repeat(rating) + 
                                 '<span class="text-gray-300">‚òÖ</span>'.repeat(5 - rating);
                    
                    return `
                        <div class="border-b pb-6 last:border-b-0">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white font-semibold text-lg flex-shrink-0">
                                    ${(comment.username || 'U').charAt(0).toUpperCase()}
                                </div>
                                <div class="flex-1">
                                    <div class="mb-2">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="font-semibold text-gray-900">${comment.username || 'Ng∆∞·ªùi d√πng'}</span>
                                            <span class="text-red-600">${stars}</span>
                                        </div>
                                        <span class="text-sm text-gray-500">${formattedDate}</span>
                                        ${currentProduct && currentProduct.brand ? `
                                            <span class="text-sm text-gray-500"> | Ph√¢n lo·∫°i h√†ng: ${currentProduct.brand}</span>
                                        ` : ''}
                                    </div>
                                    <p class="text-gray-700 leading-relaxed mb-3">${comment.comment || ''}</p>
                                    <div class="flex items-center gap-4">
                                        <button class="text-gray-500 hover:text-red-600 text-sm flex items-center gap-1 transition-colors">
                                            <i class="far fa-thumbs-up"></i>
                                            <span>H·ªØu √çch?</span>
                                        </button>
                                        ${currentUser && (currentUser.id === comment.user_id || currentUser.role === 'admin') ? `
                                            <button 
                                                onclick="deleteComment(${comment.id})" 
                                                class="text-red-500 hover:text-red-700 text-sm"
                                                title="X√≥a b√¨nh lu·∫≠n"
                                            >
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Render pagination
                if (totalPages > 1) {
                    let paginationHtml = '<div class="flex items-center gap-2">';
                    
                    if (currentCommentsPage > 1) {
                        paginationHtml += `
                            <button 
                                onclick="changeCommentsPage(${currentCommentsPage - 1}, ${productId})" 
                                class="px-3 py-2 border rounded hover:bg-red-50 hover:border-red-600"
                            >
                                &lt;
                            </button>
                        `;
                    }
                    
                    for (let i = 1; i <= totalPages; i++) {
                        if (i === 1 || i === totalPages || (i >= currentCommentsPage - 1 && i <= currentCommentsPage + 1)) {
                            paginationHtml += `
                                <button 
                                    onclick="changeCommentsPage(${i}, ${productId})" 
                                    class="px-4 py-2 border rounded ${i === currentCommentsPage ? 'bg-red-600 text-white border-red-600' : 'hover:bg-red-50 hover:border-red-600'}"
                                >
                                    ${i}
                                </button>
                            `;
                        } else if (i === currentCommentsPage - 2 || i === currentCommentsPage + 2) {
                            paginationHtml += '<span class="px-2">...</span>';
                        }
                    }
                    
                    if (currentCommentsPage < totalPages) {
                        paginationHtml += `
                            <button 
                                onclick="changeCommentsPage(${currentCommentsPage + 1}, ${productId})" 
                                class="px-3 py-2 border rounded hover:bg-red-50 hover:border-red-600"
                            >
                                &gt;
                            </button>
                        `;
                    }
                    
                    paginationHtml += '</div>';
                    document.getElementById('commentsPagination').innerHTML = paginationHtml;
                } else {
                    document.getElementById('commentsPagination').innerHTML = '';
                }
            } catch (error) {
                console.error('Error loading comments:', error);
                document.getElementById('commentsList').innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Kh√¥ng th·ªÉ t·∫£i b√¨nh lu·∫≠n: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Change comments page
        function changeCommentsPage(page, productId) {
            currentCommentsPage = page;
            loadComments(productId);
            window.scrollTo({ top: document.getElementById('commentsList').offsetTop - 100, behavior: 'smooth' });
        }

        // Helper function to get time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const weeks = Math.floor(days / 7);
            
            if (weeks > 0) return `${weeks} ${weeks === 1 ? 'tu·∫ßn' : 'tu·∫ßn'} tr∆∞·ªõc`;
            if (days > 0) return `${days} ${days === 1 ? 'ng√†y' : 'ng√†y'} tr∆∞·ªõc`;
            if (hours > 0) return `${hours} ${hours === 1 ? 'gi·ªù' : 'gi·ªù'} tr∆∞·ªõc`;
            if (minutes > 0) return `${minutes} ${minutes === 1 ? 'ph√∫t' : 'ph√∫t'} tr∆∞·ªõc`;
            return 'V·ª´a xong';
        }

        // Submit comment form
        document.getElementById('commentForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n', 'error');
                window.location.href = '/login.html';
                return;
            }

            if (!currentProduct) {
                showToast('L·ªói: Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m', 'error');
                return;
            }

            const commentText = document.getElementById('commentText').value.trim();
            const rating = parseInt(document.getElementById('commentRating').value);

            if (!commentText) {
                showToast('Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n', 'error');
                return;
            }

            try {
                const token = getToken();
                if (!token) {
                    showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i', 'error');
                    window.location.href = '/login.html';
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        product_id: currentProduct.id,
                        comment: commentText,
                        rating: rating
                    })
                });

                // Ki·ªÉm tra content-type tr∆∞·ªõc khi parse JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error(`Server tr·∫£ v·ªÅ l·ªói: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || `L·ªói ${response.status}: ${response.statusText}`);
                }

                showToast('Th√™m b√¨nh lu·∫≠n th√†nh c√¥ng!', 'success');
                
                // Clear form
                document.getElementById('commentText').value = '';
                document.getElementById('commentRating').value = '5';
                
                // Reload comments v√† rating summary
                loadComments(currentProduct.id);
                loadRatingSummary(currentProduct.id);
                
            } catch (error) {
                console.error('Error submitting comment:', error);
                showToast(error.message || 'L·ªói khi th√™m b√¨nh lu·∫≠n. Vui l√≤ng th·ª≠ l·∫°i sau.', 'error');
            }
        });

        // Delete comment
        async function deleteComment(commentId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?')) {
                return;
            }

            try {
                const token = getToken();
                if (!token) {
                    showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i', 'error');
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/comments/${commentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'L·ªói khi x√≥a b√¨nh lu·∫≠n');
                }

                showToast('X√≥a b√¨nh lu·∫≠n th√†nh c√¥ng!', 'success');
                
                // Reload comments
                if (currentProduct) {
                    loadComments(currentProduct.id);
                }
                
            } catch (error) {
                console.error('Error deleting comment:', error);
                showToast(error.message || 'L·ªói khi x√≥a b√¨nh lu·∫≠n', 'error');
            }
        }

        // Load product on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadProductDetail();
        });
    </script>
</body>
</html>

