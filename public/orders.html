<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê∆°n H√†ng C·ªßa T√¥i - TechStore</title>
    <link rel="apple-touch-icon" sizes="180x180" href="./img/logo/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./img/logo/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./img/logo/favicon-16x16.png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom styles -->
    <link rel="stylesheet" href="/styles.css">

    <style>
        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            display: flex;
            gap: 20px;
            position: relative;
            padding-bottom: 30px;
        }

        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 25px;
            top: 50px;
            width: 2px;
            height: calc(100% + 30px);
            background: #e5e7eb;
        }

        .timeline-item.active::after {
            background: #22c55e;
        }

        .timeline-dot {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #f3f4f6;
            border: 2px solid #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 20px;
            position: relative;
            z-index: 1;
        }

        .timeline-item.active .timeline-dot {
            background: #22c55e;
            border-color: #16a34a;
            color: white;
        }

        .timeline-item.completed .timeline-dot {
            background: #22c55e;
            border-color: #16a34a;
            color: white;
        }

        .timeline-content {
            flex: 1;
            padding-top: 5px;
        }

        .timeline-content h4 {
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 5px 0;
        }

        .timeline-content p {
            color: #6b7280;
            font-size: 14px;
            margin: 0;
        }

        .order-status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-paid {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-shipped {
            background: #d1fae5;
            color: #065f46;
        }

        .status-delivered {
            background: #dcfce7;
            color: #166534;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .order-card {
            transition: all 0.3s ease;
        }

        .order-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div id="site-header"></div>
    <script src="/include-partials.js" defer></script>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">
            <i class="fas fa-box mr-2 text-red-600"></i>ƒê∆°n H√†ng C·ªßa T√¥i
        </h1>

        <!-- Filter & Sort -->
        <div class="mb-6 flex flex-col sm:flex-row gap-3">
            <select id="statusFilter" class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                <option value="">T·∫•t c·∫£ ƒë∆°n h√†ng</option>
                <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                <option value="paid">ƒê√£ thanh to√°n</option>
                <option value="shipped">ƒêang giao</option>
                <option value="delivered">ƒê√£ giao</option>
                <option value="cancelled">ƒê√£ h·ªßy</option>
            </select>
            <button onclick="loadOrders()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                <i class="fas fa-sync mr-2"></i>L√†m m·ªõi
            </button>
        </div>

        <!-- Orders List -->
        <div id="ordersContainer" class="space-y-4">
            <div class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600">ƒêang t·∫£i ƒë∆°n h√†ng...</p>
            </div>
        </div>
        <div id="ordersPagination" class="mt-6 flex justify-center gap-2"></div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12 bg-white rounded-lg">
            <i class="fas fa-inbox text-5xl text-gray-400 mb-4"></i>
            <p class="text-gray-600 text-lg">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</p>
            <a href="/" class="inline-block mt-4 bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Quay l·∫°i mua s·∫Øm
            </a>
        </div>
    </div>

    <!-- Tracking Modal -->
    <div id="trackingModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-truck mr-2 text-red-600"></i>Theo D√µi ƒê∆°n H√†ng
                    </h2>
                    <button onclick="closeTrackingModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Order ID & Status -->
                <div class="mb-6 pb-6 border-b">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-600">M√£ ƒë∆°n h√†ng:</span>
                        <span id="trackingOrderId" class="font-bold text-lg">-</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Tr·∫°ng th√°i:</span>
                        <span id="trackingStatus" class="order-status-badge status-pending">-</span>
                    </div>
                </div>

                <!-- Timeline Progress -->
                <div class="mb-6 pb-6 border-b">
                    <h3 class="font-bold text-gray-800 mb-4">Qu√° Tr√¨nh Giao H√†ng</h3>
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center mb-2">
                                <i class="fas fa-check"></i>
                            </div>
                            <span class="text-xs text-center">ƒê∆°n H√†ng ƒê√£ ƒê·∫∑t</span>
                        </div>
                        <div class="flex-1 h-1 bg-green-500 mx-1"></div>
                        <div class="flex flex-col items-center flex-1">
                            <div id="step2" class="w-10 h-10 rounded-full bg-gray-300 text-white flex items-center justify-center mb-2">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <span class="text-xs text-center">Thanh To√°n</span>
                        </div>
                        <div id="line3" class="flex-1 h-1 bg-gray-300 mx-1"></div>
                        <div class="flex flex-col items-center flex-1">
                            <div id="step3" class="w-10 h-10 rounded-full bg-gray-300 text-white flex items-center justify-center mb-2">
                                <i class="fas fa-box"></i>
                            </div>
                            <span class="text-xs text-center">Giao ƒêVVC</span>
                        </div>
                        <div id="line4" class="flex-1 h-1 bg-gray-300 mx-1"></div>
                        <div class="flex flex-col items-center flex-1">
                            <div id="step4" class="w-10 h-10 rounded-full bg-gray-300 text-white flex items-center justify-center mb-2">
                                <i class="fas fa-home"></i>
                            </div>
                            <span class="text-xs text-center">Nh·∫≠n H√†ng</span>
                        </div>
                    </div>
                </div>

                <!-- Shipping Address -->
                <div class="mb-6 pb-6 border-b">
                    <h3 class="font-bold text-gray-800 mb-2">ƒê·ªãa Ch·ªâ Giao H√†ng</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="font-semibold text-gray-800" id="trackingCustomerName">-</p>
                        <p class="text-gray-600 text-sm" id="trackingPhone">-</p>
                        <p class="text-gray-600 text-sm" id="trackingAddress">-</p>
                    </div>
                </div>

                <!-- Timeline Details -->
                <div class="mb-6">
                    <h3 class="font-bold text-gray-800 mb-4">Chi Ti·∫øt Giao H√†ng</h3>
                    <div id="trackingTimeline" class="timeline">
                        <!-- Timeline items will be injected here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button onclick="closeTrackingModal()" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors font-semibold">
                        <i class="fas fa-arrow-left mr-2"></i>Quay L·∫°i
                    </button>
                    <button onclick="printTracking()" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors font-semibold">
                        <i class="fas fa-print mr-2"></i>In
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 hidden z-50 max-w-sm"></div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let currentTracking = null;

        // Check auth
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html?redirect=orders';
                return false;
            }
            return true;
        }

        // API call
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            if (!token) throw new Error('Vui l√≤ng ƒëƒÉng nh·∫≠p');

            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...(options.headers || {})
                }
            });

            const data = await response.json();
            if (!response.ok) {
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/login.html?redirect=orders';
                    return;
                }
                throw new Error(data.message || 'C√≥ l·ªói x·∫£y ra');
            }
            return data;
        }

        // Format gi√°
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN').format(price) + ' ‚Ç´';
        }

        // Format ng√†y
        function formatDate(date) {
            return new Date(date).toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Get status badge
        function getStatusBadge(status) {
            const badges = {
                pending: { class: 'status-pending', text: 'Ch·ªù x·ª≠ l√Ω' },
                paid: { class: 'status-paid', text: 'ƒê√£ thanh to√°n' },
                shipped: { class: 'status-shipped', text: 'ƒêang giao' },
                delivered: { class: 'status-delivered', text: 'ƒê√£ giao' },
                cancelled: { class: 'status-cancelled', text: 'ƒê√£ h·ªßy' }
            };
            return badges[status] || badges.pending;
        }

        // Pagination state
        let ordersPagination = { page: 1, limit: 8, totalPages: 1, totalItems: 0 };

        function renderOrdersPagination() {
            const el = document.getElementById('ordersPagination');
            if (!el) return;
            if (!ordersPagination.totalPages || ordersPagination.totalPages <= 1) {
                el.innerHTML = '';
                return;
            }

            const page = ordersPagination.page;
            const totalPages = ordersPagination.totalPages;
            let html = '';

            html += `<button ${page === 1 ? 'disabled' : ''} onclick="changeOrdersPage(${page - 1})"
                class="px-3 py-2 border rounded-lg ${page === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50'}">‚Äπ</button>`;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= page - 2 && i <= page + 2)) {
                    html += `<button onclick="changeOrdersPage(${i})"
                        class="px-3 py-2 border rounded-lg ${i === page ? 'bg-red-600 text-white border-red-600' : 'hover:bg-gray-50'}">${i}</button>`;
                } else if (i === page - 3 || i === page + 3) {
                    html += `<button disabled class="px-3 py-2 opacity-50">...</button>`;
                }
            }

            html += `<button ${page === totalPages ? 'disabled' : ''} onclick="changeOrdersPage(${page + 1})"
                class="px-3 py-2 border rounded-lg ${page === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50'}">‚Ä∫</button>`;

            el.innerHTML = html;
        }

        function changeOrdersPage(p) {
            ordersPagination.page = Math.max(1, p);
            loadOrders();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Load orders
        async function loadOrders() {
            if (!checkAuth()) return;

            try {
                const statusFilter = document.getElementById('statusFilter').value;
                const params = new URLSearchParams();
                params.set('page', String(ordersPagination.page || 1));
                params.set('limit', String(ordersPagination.limit || 8));
                const response = await apiCall(`/orders?${params.toString()}`);

                let orders = response.orders || response || [];
                if (response.pagination) {
                    ordersPagination.totalPages = Number(response.pagination.totalPages || 1);
                    ordersPagination.totalItems = Number(response.pagination.totalItems || 0);
                } else {
                    ordersPagination.totalPages = 1;
                    ordersPagination.totalItems = orders.length;
                }
                
                if (statusFilter) {
                    orders = orders.filter(o => o.status === statusFilter);
                }

                renderOrders(orders);
                renderOrdersPagination();
            } catch (error) {
                console.error('Error loading orders:', error);
                showToast(error.message, 'error');
            }
        }

        // Render orders
        function renderOrders(orders) {
            const container = document.getElementById('ordersContainer');
            
            if (!orders || orders.length === 0) {
                container.innerHTML = '';
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }

            document.getElementById('emptyState').classList.add('hidden');

            container.innerHTML = orders.map(order => {
                const statusBadge = getStatusBadge(order.status);
                const total = parseFloat(order.total || 0);
                const itemCount = order.items ? order.items.length : 0;

                return `
                    <div class="order-card bg-white rounded-lg shadow p-6">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">ƒê∆°n h√†ng #${order.id}</h3>
                                <p class="text-sm text-gray-600">${formatDate(order.created_at)}</p>
                            </div>
                            <span class="order-status-badge ${statusBadge.class}">${statusBadge.text}</span>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 py-4 border-y">
                            <div>
                                <p class="text-xs text-gray-600 mb-1">S·ªë l∆∞·ª£ng</p>
                                <p class="font-bold">${itemCount} s·∫£n ph·∫©m</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 mb-1">T·ªïng ti·ªÅn</p>
                                <p class="font-bold text-red-600">${formatPrice(total)}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 mb-1">Ph∆∞∆°ng th·ª©c</p>
                                <p class="font-bold">${order.payment_method || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 mb-1">ƒê·ªãa ch·ªâ</p>
                                <p class="font-bold text-sm">${(order.shipping_address || 'N/A').substring(0, 30)}...</p>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-3">
                            <button 
                                onclick="showTracking(${order.id})"
                                class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors font-semibold"
                            >
                                <i class="fas fa-truck mr-2"></i>Theo D√µi
                            </button>
                            <button 
                                onclick="viewOrderDetails(${order.id})"
                                class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors font-semibold"
                            >
                                <i class="fas fa-eye mr-2"></i>Chi Ti·∫øt
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show tracking
        async function showTracking(orderId) {
            try {
                const response = await apiCall(`/orders/${orderId}`);
                const order = response.order || response;

                currentTracking = order;

                // Fill info
                document.getElementById('trackingOrderId').textContent = `#${order.id}`;
                const statusBadge = getStatusBadge(order.status);
                document.getElementById('trackingStatus').className = `order-status-badge ${statusBadge.class}`;
                document.getElementById('trackingStatus').textContent = statusBadge.text;

                document.getElementById('trackingCustomerName').textContent = order.customer_name || 'N/A';
                document.getElementById('trackingPhone').textContent = order.shipping_phone || 'N/A';
                document.getElementById('trackingAddress').textContent = order.shipping_address || 'N/A';

                // Update progress steps
                updateProgressSteps(order.status);

                // Load shipment events t·ª´ API ho·∫∑c d√πng default timeline
                loadShipmentEvents(order.id);

                document.getElementById('trackingModal').classList.add('active');
            } catch (error) {
                console.error('Error loading tracking:', error);
                showToast(error.message, 'error');
            }
        }

        // Update progress steps
        function updateProgressSteps(status) {
            const steps = {
                pending: 1,
                paid: 2,
                shipped: 3,
                delivered: 4
            };
            const currentStep = steps[status] || 1;

            for (let i = 2; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                const line = document.getElementById(`line${i}`);
                if (step) {
                    if (i <= currentStep) {
                        step.className = 'w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center mb-2';
                    } else {
                        step.className = 'w-10 h-10 rounded-full bg-gray-300 text-white flex items-center justify-center mb-2';
                    }
                }
                if (line && i < 4) {
                    line.className = `flex-1 h-1 ${i < currentStep ? 'bg-green-500' : 'bg-gray-300'} mx-1`;
                }
            }
        }

        // Render timeline
        function renderTimeline(order) {
            const timeline = [
                { icon: 'üìã', title: 'ƒê∆°n H√†ng ƒê√£ ƒê·∫∑t', time: order.created_at, status: true },
                { icon: 'üí≥', title: 'ƒê∆°n H√†ng ƒê√£ Thanh To√°n', time: order.updated_at, status: order.status !== 'pending' },
                { icon: 'üì¶', title: 'ƒê√£ Giao Cho ƒêVVC', time: order.shipped_at || null, status: ['shipped', 'delivered'].includes(order.status) },
                { icon: 'üè†', title: 'ƒê√£ Nh·∫≠n ƒê∆∞·ª£c H√†ng', time: order.delivered_at || null, status: order.status === 'delivered' }
            ];

            const timelineHtml = timeline.map((item, idx) => `
                <div class="timeline-item ${item.status ? 'completed' : ''}">
                    <div class="timeline-dot">${item.icon}</div>
                    <div class="timeline-content">
                        <h4>${item.title}</h4>
                        ${item.time ? `<p>${formatDate(item.time)}</p>` : '<p class="text-gray-400">ƒêang ch·ªù x·ª≠ l√Ω...</p>'}
                    </div>
                </div>
            `).join('');

            document.getElementById('trackingTimeline').innerHTML = timelineHtml;
        }

        // Load shipment events t·ª´ API
        async function loadShipmentEvents(orderId) {
            try {
                const response = await apiCall(`/shipments/${orderId}`);
                
                if (!response.shipment) {
                    // Ch∆∞a c√≥ shipment, d√πng default timeline
                    renderTimeline(currentTracking);
                    return;
                }

                const shipment = response.shipment;
                const events = response.events || [];

                // Map shipment events to timeline
                const timelineItems = events.map(event => {
                    const statusIcons = {
                        'pending': 'üìã',
                        'picked_up': 'üì¶',
                        'in_transit': 'üöö',
                        'out_for_delivery': 'üöó',
                        'delivered': '‚úÖ',
                        'returned': '‚Ü©Ô∏è',
                        'failed': '‚ùå'
                    };

                    return {
                        icon: statusIcons[event.status] || 'üìç',
                        title: event.event_label || getStatusLabel(event.status),
                        time: event.event_time,
                        location: event.location,
                        status: true
                    };
                });

                // Render dynamic timeline
                const timelineHtml = timelineItems.map((item, idx) => `
                    <div class="timeline-item completed">
                        <div class="timeline-dot">${item.icon}</div>
                        <div class="timeline-content">
                            <h4>${item.title}</h4>
                            <p>${formatDate(item.time)}</p>
                            ${item.location ? `<p class="text-gray-400 text-xs"><i class="fas fa-map-marker-alt mr-1"></i>${item.location}</p>` : ''}
                        </div>
                    </div>
                `).join('');

                document.getElementById('trackingTimeline').innerHTML = timelineHtml || 'Ch∆∞a c√≥ c·∫≠p nh·∫≠t tracking';

            } catch (error) {
                console.error('Error loading shipment events:', error);
                // Fallback to default timeline
                renderTimeline(currentTracking);
            }
        }

        // Helper: Get status label
        function getStatusLabel(status) {
            const labels = {
                'pending': 'ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c chu·∫©n b·ªã',
                'picked_up': 'ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c nh·∫∑t t·ª´ kho',
                'in_transit': 'ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c v·∫≠n chuy·ªÉn',
                'out_for_delivery': 'ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c giao t·ªõi b·∫°n',
                'delivered': 'ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c giao th√†nh c√¥ng',
                'returned': 'ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c ho√†n tr·∫£',
                'failed': 'Giao h√†ng kh√¥ng th√†nh c√¥ng'
            };
            return labels[status] || 'C·∫≠p nh·∫≠t tr·∫°ng th√°i';
        }

        // Close modal
        function closeTrackingModal() {
            document.getElementById('trackingModal').classList.remove('active');
        }

        // Print tracking
        function printTracking() {
            if (!currentTracking) return;
            window.print();
        }

        // View order details
        function viewOrderDetails(orderId) {
            showToast('T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn', 'info');
        }

        // Show toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            toast.className = `fixed bottom-4 right-4 ${bgColor} text-white rounded-lg shadow-lg p-4 z-50 max-w-sm`;
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Close modal on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTrackingModal();
            }
        });

        // Close modal on background click
        document.getElementById('trackingModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('trackingModal')) {
                closeTrackingModal();
            }
        });

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            if (checkAuth()) {
                // Wait for orders to load first
                await loadOrders();

                // If a focus query param is present (e.g. ?focus=123), open tracking for that order
                const params = new URLSearchParams(window.location.search);
                const focus = params.get('focus');
                if (focus) {
                    // Try to parse to integer
                    const orderId = parseInt(focus, 10);
                    if (!isNaN(orderId)) {
                        // open tracking modal
                        showTracking(orderId);
                        // remove focus param from URL to avoid re-opening on reload
                        params.delete('focus');
                        const newSearch = params.toString();
                        const newUrl = window.location.pathname + (newSearch ? ('?' + newSearch) : '');
                        window.history.replaceState({}, document.title, newUrl);
                    }
                }
            }
        });

        // Filter change
        document.getElementById('statusFilter').addEventListener('change', loadOrders);
    </script>
</body>
</html>
