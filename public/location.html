<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Các cửa hàng gần bạn - TechStore</title>
  <!-- Google Maps will be loaded dynamically -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/styles.css">
  <style>
    #map { height: 420px; }
    .store-item { border-bottom: 1px solid #eee; padding: 12px; }
    .system-chip { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; margin-right:6px; }
    .chip-techstore { background:#fee2e2; color:#991b1b; }
    .chip-cellphone { background:#fde68a; color:#92400e; }
    .chip-dtv { background:#dbeafe; color:#1e40af; }
    .chip-care { background:#e0f2fe; color:#0369a1; }
  </style>
</head>
<body class="bg-gray-50 font-sans">
  <div id="site-header"></div>
  <script src="/include-partials.js" defer></script>

  <main class="container mx-auto px-4 py-8 max-w-6xl">
    <h1 class="text-3xl font-bold mb-4">Tìm cửa hàng gần bạn</h1>

    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
          <div class="mb-3">Chọn hệ thống cửa hàng:</div>
          <div class="flex gap-3 items-center">
            <label class="flex items-center gap-2"><input type="radio" name="system" value="all" checked> Tất cả</label>
          </div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="searchInput" placeholder="Nhập vị trí để tìm cửa hàng gần nhất" class="col-span-2 border rounded px-3 py-2" />
            <button id="searchBtn" class="bg-red-600 text-white px-4 py-2 rounded">Tìm</button>
          </div>

          <div class="mt-4">
            <label class="text-sm text-gray-600">Chọn tỉnh/thành</label>
            <select id="citySelect" class="w-full border rounded p-2 mt-1">
              <option value="">-- Chọn tỉnh/thành --</option>
              <option value="TPHCM">TP. Hồ Chí Minh</option>
              <option value="HN">Hà Nội</option>
            </select>
          </div>
        </div>

        <div class="md:w-1/2">
          <div id="map" class="rounded"></div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div>
        <div class="bg-white rounded-lg shadow p-4">
          <h2 class="font-bold mb-3">Danh sách cửa hàng</h2>
          <div id="storesList">
            <p class="text-sm text-gray-500">Đang tải cửa hàng...</p>
          </div>
          <div class="mt-4 flex justify-center gap-2" id="storesPagination"></div>
        </div>
      </div>

      <div class="md:col-span-2">
        <div class="bg-white rounded-lg shadow p-4">
          <h2 class="font-bold mb-3">Bản đồ</h2>
          <p class="text-sm text-gray-500 mb-3">Nhấp vào một cửa hàng ở danh sách để xem hình ảnh và vị trí.</p>
          <div id="mapLarge" style="height:360px; display: none;"></div>
          <div id="storeImageContainer" style="display: none; text-align: center; padding: 20px;">
            <img id="storeImage" src="" alt="Hình ảnh cửa hàng" style="max-width: 100%; max-height: 320px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" />
            <div id="storeImageInfo" class="mt-3 text-sm text-gray-600"></div>
          </div>
          <div id="mapPlaceholder" style="height: 360px; display: flex; align-items: center; justify-content: center; background: #f3f4f6; border-radius: 8px; color: #6b7280;">
            <div style="text-align: center;">
              <svg style="width: 64px; height: 64px; margin: 0 auto 16px; opacity: 0.5;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
              </svg>
              <p>Chọn một cửa hàng để xem hình ảnh</p>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- Image modal (hidden by default) -->
  <div id="imgModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded shadow-lg max-w-3xl w-full mx-4 overflow-hidden">
      <div class="flex justify-between items-center p-2 border-b">
        <div id="imgModalCaption" class="font-semibold px-2"></div>
        <button onclick="closeImageModal()" class="text-gray-600 px-3 py-1">Đóng ✕</button>
      </div>
      <div class="p-4 flex items-center justify-center" style="background:#f7f7f7;">
        <img id="imgModalImg" src="" alt="" style="max-width:100%; max-height:70vh;" />
      </div>
    </div>
  </div>

  <script>
    // Google Maps + dynamic stores via /api/stores
    let stores = [];
    let map, mapLarge, markers = [], infoWindow;
    let storesListPage = 1;
    const storesPerPage = 8;

    async function getConfig() {
      try {
        const r = await fetch('/api/config');
        return await r.json();
      } catch (e) {
        return { googleMapsApiKey: '' };
      }
    }

    function loadGoogleMaps(apiKey) {
      return new Promise((resolve, reject) => {
        if (!apiKey) return reject(new Error('Missing Google Maps API key'));
        if (window.google && window.google.maps) return resolve(window.google.maps);
        window.initGMaps = function() { resolve(window.google.maps); };
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initGMaps`;
        script.async = true;
        script.defer = true;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    async function fetchStoresApi(filterSystem = 'all', q = '', city = '') {
      try {
        const params = new URLSearchParams({ page: 1, limit: 500 });
        if (filterSystem && filterSystem !== 'all') params.set('system', filterSystem);
        if (q) params.set('search', q);
        if (city) params.set('city', city);
        const res = await fetch(`/api/stores?${params.toString()}`);
        const data = await res.json();
        return data.stores || [];
      } catch (e) {
        console.error('Failed to load /api/stores', e);
        return [];
      }
    }

    function sliceStoresForList(storesList) {
      const start = (storesListPage - 1) * storesPerPage;
      return (storesList || []).slice(start, start + storesPerPage);
    }

    function renderStoresPagination(totalItems) {
      const el = document.getElementById('storesPagination');
      if (!el) return;
      const totalPages = Math.max(1, Math.ceil((totalItems || 0) / storesPerPage));
      if (totalPages <= 1) { el.innerHTML = ''; return; }

      const page = storesListPage;
      let html = '';
      html += `<button ${page === 1 ? 'disabled' : ''} class="px-3 py-2 border rounded-lg ${page === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50'}" onclick="changeStoresPage(${page - 1})">‹</button>`;
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= page - 2 && i <= page + 2)) {
          html += `<button class="px-3 py-2 border rounded-lg ${i === page ? 'bg-red-600 text-white border-red-600' : 'hover:bg-gray-50'}" onclick="changeStoresPage(${i})">${i}</button>`;
        } else if (i === page - 3 || i === page + 3) {
          html += `<button disabled class="px-3 py-2 opacity-50">...</button>`;
        }
      }
      html += `<button ${page === totalPages ? 'disabled' : ''} class="px-3 py-2 border rounded-lg ${page === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50'}" onclick="changeStoresPage(${page + 1})">›</button>`;
      el.innerHTML = html;
    }

    window.changeStoresPage = function(p) {
      storesListPage = Math.max(1, p);
      if (typeof google !== 'undefined' && map) {
        renderStoresOnMap(stores);
      } else {
        renderStoresAsimg(stores);
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    function clearMarkers() {
      markers.forEach(m => m.setMap(null));
      markers = [];
    }

    function renderStoresOnMap(storesList) {
      const list = document.getElementById('storesList');
      list.innerHTML = '';
      clearMarkers();

      if (!storesList || storesList.length === 0) {
        list.innerHTML = '<p class="text-sm text-gray-500">Không tìm thấy cửa hàng</p>';
        renderStoresPagination(0);
        return;
      }

      const bounds = new google.maps.LatLngBounds();

      storesList.forEach(s => {
        const el = document.createElement('div');
        el.className = 'store-item';
        let chipClass = '';
        if (s.system === 'techstore') chipClass = 'chip-techstore';
        else if (s.system === 'cellphone') chipClass = 'chip-cellphone';
        else if (s.system === 'dienthoaivui') chipClass = 'chip-dtv';
        else if (s.system === 'care') chipClass = 'chip-care';

        el.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <div class="text-sm text-gray-500 mb-1"><span class="system-chip ${chipClass}">${s.system}</span></div>
              <div class="font-semibold">${s.name}</div>
              <div class="text-xs text-gray-600">${s.address}</div>
              <div class="text-xs text-gray-600 mt-1">SĐT: ${s.phone}</div>
            </div>
            <div class="text-right">
              <button class="text-sm text-blue-600" onclick="zoomToStore(${s.id})">Xem trên bản đồ</button>
            </div>
          </div>
        `;

        el.addEventListener('click', () => { zoomToStore(s.id); });
        list.appendChild(el);

        if (s.lat && s.lng) {
          const pos = new google.maps.LatLng(s.lat, s.lng);
          const marker = new google.maps.Marker({ position: pos, map: map, title: s.name });
          marker.storeId = s.id;
          marker.addListener('click', () => {
            const content = `<div><strong>${s.name}</strong><div style="font-size:12px">${s.address}</div><div style="font-size:12px">SĐT: ${s.phone}</div></div>`;
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
            map.panTo(pos);
            map.setZoom(15);
          });
          markers.push(marker);
          const marker2 = new google.maps.Marker({ position: pos, map: mapLarge, title: s.name });
          marker2.addListener('click', () => {
            const content = `<div><strong>${s.name}</strong><div style="font-size:12px">${s.address}</div><div style="font-size:12px">SĐT: ${s.phone}</div></div>`;
            infoWindow.setContent(content);
            infoWindow.open(mapLarge, marker2);
            mapLarge.panTo(pos);
            mapLarge.setZoom(15);
          });
          bounds.extend(pos);
        }
      });

      if (!bounds.isEmpty) {
        map.fitBounds(bounds);
        mapLarge.fitBounds(bounds);
      }

      // Render paginated list (markers already added for all stores)
      list.innerHTML = '';
      sliceStoresForList(storesList).forEach(s => {
        const el = document.createElement('div');
        el.className = 'store-item';
        let chipClass = '';
        if (s.system === 'techstore') chipClass = 'chip-techstore';
        else if (s.system === 'cellphone') chipClass = 'chip-cellphone';
        else if (s.system === 'dienthoaivui') chipClass = 'chip-dtv';
        else if (s.system === 'care') chipClass = 'chip-care';
        el.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <div class="text-sm text-gray-500 mb-1"><span class="system-chip ${chipClass}">${s.system}</span></div>
              <div class="font-semibold">${s.name}</div>
              <div class="text-xs text-gray-600">${s.address}</div>
              <div class="text-xs text-gray-600 mt-1">SĐT: ${s.phone}</div>
            </div>
            <div class="text-right">
              <button class="text-sm text-blue-600" onclick="zoomToStore(${s.id})">Xem trên bản đồ</button>
            </div>
          </div>
        `;
        el.addEventListener('click', () => { zoomToStore(s.id); });
        list.appendChild(el);
      });
      renderStoresPagination(storesList.length);
    }

    function openImageModal(imgUrl, title) {
      const modal = document.getElementById('imgModal');
      const img = document.getElementById('imgModalImg');
      const caption = document.getElementById('imgModalCaption');
      img.src = imgUrl;
      caption.textContent = title || '';
      modal.classList.remove('hidden');
    }

    function closeImageModal() {
      const modal = document.getElementById('imgModal');
      const img = document.getElementById('imgModalImg');
      img.src = '';
      modal.classList.add('hidden');
    }

    function zoomToStore(id) {
      const s = stores.find(x => x.id === id);
      if (!s) return;

      // try to pan map if available
      try {
        if (s.lat != null && s.lng != null && typeof google !== 'undefined' && map) {
          const pos = new google.maps.LatLng(s.lat, s.lng);
          map.panTo(pos); map.setZoom(16);
          if (mapLarge) {
            mapLarge.panTo(pos); mapLarge.setZoom(16);
          }
          const m = markers.find(mm => mm.storeId === id);
          if (m && infoWindow) {
            infoWindow.setContent(`<div><strong>${s.name}</strong><div style="font-size:12px">${s.address}</div><div style="font-size:12px">SĐT: ${s.phone}</div></div>`);
            infoWindow.open(map, m);
          }
        }
      } catch (e) {
        // ignore map errors
      }

      // Show image in right panel
      const imgContainer = document.getElementById('storeImageContainer');
      const imgElement = document.getElementById('storeImage');
      const imgInfo = document.getElementById('storeImageInfo');
      const mapPlaceholder = document.getElementById('mapPlaceholder');
      const mapLargeDiv = document.getElementById('mapLarge');

      if (imgContainer && imgElement && imgInfo) {
        // Try to load image, fallback to placeholder if not found
        const imgUrl = s.image || `/img/stores/store-${s.id}.jpg` || '/img/store-placeholder.png';
        
        // Show image container, hide placeholder
        if (mapPlaceholder) mapPlaceholder.style.display = 'none';
        if (mapLargeDiv) mapLargeDiv.style.display = 'none';
        imgContainer.style.display = 'block';
        
        // Load image with error handling
        imgElement.onerror = function() {
          this.src = '/img/store-placeholder.png';
        };
        imgElement.src = imgUrl;
        imgElement.alt = s.name;
        
        // Show store info
        imgInfo.innerHTML = `
          <div class="font-semibold text-gray-800">${s.name}</div>
          <div class="text-gray-600 mt-1">${s.address}</div>
          <div class="text-gray-600 mt-1">SĐT: ${s.phone}</div>
        `;
      }
    }

    window.zoomToStore = zoomToStore;

    function renderStoresAsimg(storesList) {
      const list = document.getElementById('storesList');
      list.innerHTML = '';
      if (!storesList || storesList.length === 0) {
        list.innerHTML = '<p class="text-sm text-gray-500">Không tìm thấy cửa hàng</p>';
        renderStoresPagination(0);
        return;
      }

      sliceStoresForList(storesList).forEach(s => {
        const el = document.createElement('div');
        el.className = 'store-item flex items-center gap-4 p-3 border-b';
        const imgUrl = s.image || '/img/store-placeholder.png';
        el.innerHTML = `
          <img src="${imgUrl}" alt="${s.name}" class="w-24 h-24 object-cover rounded">
          <div class="flex-1">
            <div class="font-semibold">${s.name}</div>
            <div class="text-xs text-gray-600">${s.address}</div>
            <div class="text-xs text-gray-600 mt-1">SĐT: ${s.phone}</div>
          </div>
          <div class="text-right">
            <button class="text-sm text-blue-600" onclick="zoomToStore(${s.id})">Xem trên bản đồ</button>
          </div>
        `;
        list.appendChild(el);
      });
      renderStoresPagination(storesList.length);
    }

    async function initLocationPage() {
      const cfg = await getConfig();
      let mapsLoaded = false;
      if (cfg && cfg.googleMapsApiKey) {
        try {
          await loadGoogleMaps(cfg.googleMapsApiKey);
          mapsLoaded = true;
        } catch (e) {
          console.warn('Google Maps failed to load, falling back to img.', e);
          mapsLoaded = false;
        }
      }

      // Try to load stores from API; fallback to static JSON if API not available
      stores = await fetchStoresApi();
      if ((!stores || stores.length === 0)) {
        try {
          const r = await fetch('/data/stores.json');
          stores = await r.json();
        } catch (e) {
          stores = [];
        }
      }
      storesListPage = 1;

      if (mapsLoaded) {
        map = new google.maps.Map(document.getElementById('map'), { center: { lat: 10.776889, lng: 106.694444 }, zoom: 12 });
        mapLarge = new google.maps.Map(document.getElementById('mapLarge'), { center: { lat: 10.776889, lng: 106.694444 }, zoom: 12 });
        infoWindow = new google.maps.InfoWindow();
        renderStoresOnMap(stores);
      } else {
        // Hide map containers and render simple image list for demo
        try { document.getElementById('map').style.display = 'none'; } catch(e){}
        try { document.getElementById('mapLarge').style.display = 'none'; } catch(e){}
        renderStoresAsimg(stores);
      }

      document.getElementById('searchBtn').addEventListener('click', async () => {
        const q = document.getElementById('searchInput').value || '';
        const city = document.getElementById('citySelect').value || '';
        const sys = document.querySelector('input[name="system"]:checked') ? document.querySelector('input[name="system"]:checked').value : 'all';
        const newStores = await fetchStoresApi(sys, q, city);
        stores = (newStores && newStores.length) ? newStores : stores;
        storesListPage = 1;
        if (mapsLoaded) renderStoresOnMap(stores); else renderStoresAsimg(stores);
      });

      document.querySelectorAll('input[name="system"]').forEach(r => r.addEventListener('change', async () => {
        const q = document.getElementById('searchInput').value || '';
        const city = document.getElementById('citySelect').value || '';
        const sys = document.querySelector('input[name="system"]:checked').value || 'all';
        const newStores = await fetchStoresApi(sys, q, city);
        stores = (newStores && newStores.length) ? newStores : stores;
        storesListPage = 1;
        if (mapsLoaded) renderStoresOnMap(stores); else renderStoresAsimg(stores);
      }));

      document.getElementById('citySelect').addEventListener('change', async () => {
        const q = document.getElementById('searchInput').value || '';
        const city = document.getElementById('citySelect').value || '';
        const sys = document.querySelector('input[name="system"]:checked').value || 'all';
        const newStores = await fetchStoresApi(sys, q, city);
        stores = (newStores && newStores.length) ? newStores : stores;
        storesListPage = 1;
        if (mapsLoaded) renderStoresOnMap(stores); else renderStoresAsimg(stores);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      initLocationPage();
    });
  </script>
</body>
</html>